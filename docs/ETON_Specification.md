# ETON 技術仕様書 (Specification)

**Efficient Token-Oriented Notation (ETON)** は、LLMエージェントによる高密度かつ高信頼なデータ処理を目的とした、ステートフルなデータプロトコルです。

## 1. 設計思想 (Design Philosophy)

ETON は、TOON 等の「無状態・堅牢」なフォーマットとは対照的に、**「状態保持・効率」** を最優先します。

1.  **Stateful Compression**: 頻出文字列を「辞書」として分離。セッション間で辞書を共有することで、繰り返し通信の冗延性を排除。
2.  **Schema-First**: データの構造を事前に定義し、各行からキー名を排除。
3.  **LLM-Optimized**: トークナイザーの特性を考慮し、デリミタやシンボルの選定を最適化。

---

## 2. コア・シンタックス (Core Syntax)

ETON ストリームおよびファイルは、以下のブロックで構成されます。

### 2.1 スキーマ定義 (`%Schema`)
レコードのフィールド構造を宣言します。
```csv
%Schema:User
id,name,role
```

### 2.2 辞書定義 (`%Symbol`)
文字列実体とシンボル（`@` + ID）の対応を定義します。
```csv
%Symbol
"Alice",@1
"Admin",@2
```

### 2.3 データ開始マーカー (`%Data`)
これ以降が行指向のデータレコードであることを示します。

### 3. データ (Data)

データ本体は `%Data` 行で始まり、以降は辞書（Symbol ID）または生値で構成される CSV 行が続きます。

**基本ルール:**
*   `@ID` は辞書で定義された値に展開されます。
*   `!RAW` で始まる行は `!AUDIT` 行として扱われ、値の検証に使用されます。

### 4. ストリーミング拡張 (Incremental Dictionary)

ETON は、長時間のストリーミングにおいて未知の単語が出現した場合、動的に辞書を更新（追記）することを許可します。

```csv
%Schema:Log
timestamp,level,message
%Symbol
INFO,@1
WARN,@2
%Data
10:00,@1,"Started"
10:01,@2,"Low memory"
# ここで新しいレベル "ERROR" が出現した場合、%Symbol を再度発行できる
%Symbol
ERROR,@3
%Data
10:05,@3,"Crash!"
```

*   **インターリーブ**: `%Symbol` ブロックは `%Data` ブロックの間に何度でも出現可能です。
*   **前方参照の禁止**: データ行で使用されるシンボルは、必ず**それより前**の `%Symbol` ブロック（または初期辞書）で定義されている必要があります。
```csv
!AUDIT:1
```

---

## 3. データ型とシリアライズ

- **String**: 
    - 辞書に登録されたものは `@1` 等のシンボル。
    - 未登録のものは標準的なクォート付き文字列。
- **Number**: 整数および浮動小数点。
- **Boolean**: `true` / `false`。
- **Null**: 空セルまたは `_`（実装による）。
- **List**: `(item1;item2)` 形式を推奨（ネスト対応）。

---

## 4. 運用モード

### 4.1 バッチモード (Batch)
辞書とデータを一度に送信。RAG のコンテキスト注入などに最適。

### 4.2 ストリーミングモード (Streaming)
通信の途中で新規シンボルが登場した場合、`%Symbol` ブロックを随時挿入（インターリーブ）する「追記型辞書」を採用。

---

## 5. 重要な制約

- **Read-Only Protocol**: ETON は LLM への **入力専用** です。LLM に ETON を生成させることは推奨されません。
- **統計的保証**: 大規模な推論精度テストは保留されており、利用者は自身のケースで精度確認（スモークテスト）を行う必要があります。
